stages:
  - deploy
  - test

.deploy:
  stage: deploy
  tags:
    - meao
  script:
    - kubectl apply -f ${DEPLOYMENT}
    - bin/rollout-status.sh ${DEPLOYMENT}

.test:
  stage: test
  tags:
    - meao
  retry:
    max: 1
    when: always
  script:
    - bin/acceptance-tests.sh ${TEST_SUITE}

deploy-iowa-a-dev:
  extends: .deploy
  only:
    changes:
      - "iowa-a/bedrock-dev/*"
    refs:
      - master
  variables:
    DEPLOYMENT: iowa-a/bedrock-dev

deploy-iowa-b-dev:
  extends: .deploy
  only:
    changes:
      - "iowa-b/bedrock-dev/*"
    refs:
      - master
  variables:
    DEPLOYMENT: iowa-b/bedrock-dev

deploy-iowa-a-stage:
  extends: .deploy
  only:
    changes:
      - "iowa-a/bedrock-stage/*"
    refs:
      - master
  variables:
    DEPLOYMENT: iowa-a/bedrock-stage

deploy-iowa-b-stage:
  extends: .deploy
  only:
    changes:
      - "iowa-b/bedrock-stage/*"
    refs:
      - master
  variables:
    DEPLOYMENT: iowa-b/bedrock-stage

test-demo1-headless:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo1
  variables:
    BASE_URL: http://www-demo1.allizom.org
    TEST_SUITE: headless

test-demo2-headless:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo2
  variables:
    BASE_URL: http://www-demo2.allizom.org
    TEST_SUITE: headless

test-demo3-headless:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo3
  variables:
    BASE_URL: http://www-demo3.allizom.org
    TEST_SUITE: headless

test-demo4-headless:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo4
  variables:
    BASE_URL: http://www-demo4.allizom.org
    TEST_SUITE: headless

test-demo5-headless:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo5
  variables:
    BASE_URL: http://www-demo5.allizom.org
    TEST_SUITE: headless

test-demo5-chrome:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo5
  variables:
    BASE_URL: http://www-demo5.allizom.org
    TEST_SUITE: chrome

test-demo5-firefox:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo5
  variables:
    BASE_URL: http://www-demo5.allizom.org
    TEST_SUITE: firefox

test-demo5-ie:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo5
  variables:
    BASE_URL: http://www-demo5.allizom.org
    TEST_SUITE: ie

test-demo5-ie9:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo5
  variables:
    BASE_URL: http://www-demo5.allizom.org
    TEST_SUITE: ie9

test-demo5-download:
  extends: .test
  stage: test
  tags:
    - aws
    - meao
  only:
    refs:
      - test-demo5
  variables:
    BASE_URL: http://www-demo5.allizom.org
    TEST_SUITE: download

test-dev-headless:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-dev/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-dev.gcp.moz.works
    TEST_SUITE: headless

test-stage-headless:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-stage/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: headless

test-prod-frankfurt-headless:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "frankfurt/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-prod.frankfurt.moz.works
    TEST_SUITE: headless

test-prod-gcp-headless:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: headless

test-prod-gcp-chrome:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: chrome

test-prod-gcp-firefox:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: firefox

test-prod-gcp-ie:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: ie

test-prod-gcp-ie9:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: ie9

test-prod-gcp-download:
  extends: .test
  stage: test
  tags:
    - gcp
    - meao
  only:
    changes:
      - "iowa-*/bedrock-prod/*"
    refs:
      - master
  variables:
    BASE_URL: https://bedrock-stage.gcp.moz.works
    TEST_SUITE: download
